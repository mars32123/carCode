# 调车日志
## 2.19日

疏通优化摄像头核心算法
1.将二值化阈值动态地由最近行的基本白点灰度决定，迎合摄像头算法
2.腐蚀图像，减少图像噪点
3.增加将--OFFLINE扫到中心点为黑色点  --停止  可以将减少OFFLINE的跳变  增加图像稳定性
4.如果画面抖动，说明dma中断中的图像处理时间过长影响了图像数据传输，需要转移位置

## 2.20日
1.摄像头图像处理函数是不是放DMA中断之后？感觉算力快不够了，之后需要将图像帧数降低或者减小图像大小
在诸葛的帮助下   解决此问题  将显示函数从DMA中断函数移开。
2.

## 2.22日
控制的基本思路：

1.有可视距离决定速度
2.由可视距
## 2.23日
控制的基本思路：
电磁不限长，稳成绩
tmd怎么这么难调，分元素训练吧，模糊和线性P差不多，直道尽量小P
摩擦力系数太TMD小   换轮胎应该效果会好多了
采用分段PD


## 2.25日


增加元素识别

十字（同时处理）
S
大湾
小湾


十字的检测还要重修，把检测阈值缩小，恢复阈值放大，做到精准检测，入环不提前转向。

将边线追逐舍弃了，还没有发现问题


## 3.3日

添加上舵机积分项是不是会好一点  消除抖动？  试试看

使用最小二乘法

/************************************************************************
## 3.4日
************************************************************************/
使用动态二次P   
效果还行    添加加减速。
速度整定
因为我当时把采集图像的周期和舵机控制的周期没有协调好，
当时我采集一幅图像的时间里面却做了两次舵机控制，所以那个D根本就没有起到作用。
P在一个50半径的弯道上刚好合适的时候就是P应该有的最大值，在这个地方也可以测出舵机打角的范围（方向PWM限幅；
然后把P做成满足要求的二次函数， 然后给一个很大的固定D值， 车子在方向上就差不多了。
楼主的帖子里面怎么做这个P说的很清楚吧，我就不详细说了，我也是按着他说的一步一步来的，效果真的很好。
但是要注意的是，P不能够太大也不能太小，P给的非常大车子过小S什么的会甩起来，舵机PWM的范围也要合适，
D要尽量大一些，（我用的是P的8倍的样子）。还有就是，不同舵机的P值范围不一样，舵机PWM范围也不一样。
当然这些控制的P啊 D啊什么的要有用， 还是看你采集的图像有没有用，采集周期和控制周期有没有调节好，
等等，图像都没对，就不能做巡线处理，巡线都没做好，控制都白谈了。
/************************************************************************
## 3.5日
************************************************************************/

换了电池之后，满占空比复位现象消失了。
调试了一个还行的直道PD
先凑合一个电机PI
明晚试试新写的动态P和控速函数。


等速度提上来后上电磁条元素
/************************************************************************
## 3.6日
************************************************************************/

比较点  27
SPL 114  SPH1.3   SD  19
SPL 140  SPH 1.4  SD  19
由计算结果  
可以尝试第一个二次P  SPL  100   SPH   4   SD   4

我们通过测试发现用 PD  控制来控制舵角可以取得较好的效果。将图象经过算法处理后得到的黑线位置和对应的舵机 PD 参照角度处理成一次线性关系。
在 Ki 置零的情况下， 舵机在这种动态随动系统对动态响应性能要求更高。更重要的是，我们通过合理调节 Kp 参数，发现车能在直线高速行驶时仍能保持车身非常稳定，
没有震荡，所以基本没有必要使用
Ki 参数；其中，P 项是在图像中选出一行，计算出其中黑线与图像中心位置的偏差，将选定行的黑线位置与上一幅图片中的位置相减，
从而反映其变化率，在测试中，我们发现增加
P 项系数可以最强车模的沿线能力，并且可以使车模的转向提前，实现切弯效果。算法中加入 D 项后，可以使车模入弯时转向提前，
出弯时转向减少，对大 S 弯切线很有好处。降低 P 系数而增加 D 系数可以使车模在大 S 弯内切线的程度增加，在大半径弧线中的切线量减少。 
通过选择转向参考行、设置 PD 系数以及调整转角曲线，可以将车模的行车线调整到一个较为理想的状态。当车模与黑线的偏差增大时，给定速度降低，
当车模与黑线的偏差减小时，给定速度增加。这样可以在一定程度上使车模入弯时减速提前，出弯时加速提前。
/************************************************************************
## 3.6日
************************************************************************/

速度差不多2m   D给的很大的时候  会导致过弯灵活但是直道微抖，但是D小的时候 直道会调不过来  所以应该等直道调过来的时候降低P  也就是当偏差减小或者变化
率减小的时候降低D

/************************************************************************
## 3.7日
************************************************************************/

换胎之后单PD可以跑到70迈  但是抖   P 2.0  D 2.7左右过弯时轨迹不好  P小了  内切不了   但是P大了 容易抖  还是D需要变大？
P 3.4   D  1.82     

/************************************************************************
## 3.10日
************************************************************************/


C舵机试了试  感觉之前给的P是不是大了?  

试试把程序框架改一改
 
新增模糊P   细节调试 试试看   效果不错   

/************************************************************************
## 3.11日
************************************************************************/
在跑的时候把菜单和显示关了，舵机迟滞明显降低，过弯很丝滑，提速到2.8M左右，有了质的飞跃   我真是个傻逼
终于把控制问题解决了  现在能安心做图像和识别了

/************************************************************************
## 3.16日
************************************************************************/

对十字和坡道稍作处理，将延长线补回来。坡道成功识别。


/************************************************************************
## 3.18日
************************************************************************/
函数使用CPU1进行处理  移植完成
新赛道不太稳  速度上不太去  感觉软件结构已经没有什么问题
函数延时实测后  算力有余
控制有待改善
硬件测试通过  下周调元素

/************************************************************************
## 3.25日
************************************************************************/
重回CPU0  可能逐飞改动之后导致DMA传输不是很稳定了
使用50行图像  元素特征更加明显。
图像也更加稳定  不会再错位了

/************************************************************************
## 3.26日
************************************************************************/
暂时去掉中线黑  截止的判断


/************************************************************************
## 4.3日
************************************************************************/
增加元素处理


先稳定识别，在稳定处理，再调电机，再调方向，升速度。

那个消除等折点代码应该注释  不然三岔口的一号标志识别不到

需要测试OUTIN在代码里面的用处

圆环识别差不多了
/************************************************************************
## 4.6日
************************************************************************/

入环还需要增加距离限制
电磁阈值还需优化

/************************************************************************
## 4.13日
************************************************************************/
分区二值化  边角的暗块好了点  暂时不明原因
出库写好
明天写入库！

/************************************************************************
## 4.14日
************************************************************************/
岔路口误判在出十字无法解决，偏差*距离来限制  达到放抖的效果z
入库还要优化 
圆环还要优化
怎么锁住补线点是最关键的问题。
肝了一晚上  
三叉消抖成功！！！


/************************************************************************
## 4.16日
************************************************************************/
成功入环。
处理三叉！

> OFF+1  
边沿描线中的OFF决定了最关键的信息
在OFF上的数据就不在准确 在使用的时候不能遍历到OFF上


/************************************************************************
## 4.18日
************************************************************************/
全元素不稳定完赛
策略
1.限制第一次岔路口距离   解除距离限制后                   标志位为1 
2.岔路口的下一个元素一般为出岔口，所以可以给出岔口降低阈值   标志位为2
3.出岔口后下一个元素是停车线  这一段不识别岔路口          标志位为3
4.停车线到第一次岔口距离也可以基本不识别岔路口        
5.二次进岔口                                              标志位为4
6.二次出岔口                                              标志位为5

/************************************************************************
## 4.21日
************************************************************************/
函数有待优化  少使用双FOR循环，提高图像帧率缩短控制周期

使用电磁判断元素节省算力 然后缩短控制周期
/************************************************************************
## 4.23日
************************************************************************/


心态炸
记得改优先级
休息一段时间

/************************************************************************
## 5.3日
************************************************************************/
优化了十字   但是补线那里还得考虑 尽量是在双边丢线的情况下才补线
/************************************************************************
## 5.5日
************************************************************************/
在识别第一次斑马线后再换岔路补线
岔路口减速 用电磁判断
之前的版本进入岔路口问题不大  但是出来还要放低阈值
试试用摄像头结合电磁消抖吧  问题不大
首先把策略改成斑马线换边
先试试之前版本的效果
如果进三叉有问题 看看是不是近端特征成无边了  加上这个情况    或者把扫线范围变宽  按理来说应该没什么问题
可以放宽一点阈值
然后出来的时候可以OFFLne或者进一步放宽阈值    
在岔路口里面减速
/************************************************************************
## 5.9日
************************************************************************/

自制硬件完赛
入三叉那里的有点反光  有点影响图像  
基本全元素稳定完赛  把补线程序延长线程序重新加上看看效果
入库 出库优化后  把控制前瞻优化一下就可以下班了 还有电机调硬


/************************************************************************
## 5.10日
************************************************************************/

三叉的问题 可能是延长线函数的问题 也可能是Ku标志位的问题  具体还要看
加了一个三岔口减速的程序
/************************************************************************
## 5.14日
************************************************************************/
三叉不稳用距离限制一下吧
电机重新调一下 试试位置式 但是应该还是增量式好  最后先调I再调P
wideoffline改成5试试
轮胎多泡吧

增加了位置式电机PI  增量式换了一种写法
左圆环写了一下
然后车道线防抖改小成100
/************************************************************************
## 5.17日
************************************************************************/

进一步优化圆环、


/************************************************************************
## 5.18日
************************************************************************/
  元素较为稳定  完赛率能到百分之70左右
  十字的图像还需要优化
/************************************************************************
## 5.20日
************************************************************************/

出现一些玄学问题  无法解释、

换驱动之后没事了
/************************************************************************
## 5.20日
************************************************************************/

圆环进换有过早的问题
试试把补线半径增大 
加点速冲
三叉出口有点不稳定  奇怪草了  是不是 路径不稳的问题
三叉出来去掉一个条件试试
半径改为20
/************************************************************************
## 5.21日
************************************************************************/
关于三叉可以试试用一段距离的持续补线来使他更加稳定 
但是有可能是造成误判的时候回不来  就需要用距离限制了
 P不要太大
/************************************************************************
## 5.22日
************************************************************************/
1.写好调试flash和方案决策
2.重写出界保护
3.出圆环补线
由于首5行都是有边 所以要注意

先用远哥的试试flash
明天先检查flash写入是否正常
再检查用flash带进去是否正常
再看出圆环补线是否正常
在看出库是否正常

速度80
P 0.38 D 0.5
TOW 20
12 6 10

下午稳定完赛
80
P 0.35 0.37 0.38 0.39 0.39 0.41 0.41
12 5 7 35 
D 0.5
TOW 19
/************************************************************************
## 5.23日
************************************************************************/
两个圆环  两个斜率 两个P
试试变速  感觉祖传的会更好了
/************************************************************************
## 5.24日
************************************************************************/

阈值对元素识别和赛道路径也会有影响  跑之前要整定好  晚上应该都差不多
感觉加了出环延长线之后出环路径好了但是好像三叉不那么容易识别了  
看下到时候用不用吧  可以写个MODEL  可以试试放宽阈值
放宽到出环识别应该会好很多

/************************************************************************
## 5.25日
************************************************************************/
入库还要微修


/************************************************************************
## 5.26日
************************************************************************/
这几天先不改动了  完赛稳定性较强  有百分之50以上的完赛率


/************************************************************************
## 5.27日
************************************************************************/

入库微修  
三叉P变大一点    
MIDDLE到40直道更加正
/************************************************************************
## 5.30日
************************************************************************/
校赛 冲
/************************************************************************
## 6.4日
************************************************************************/
接下来的任务。
上陀螺仪，
电磁寻迹，
左右环正常处理
硬件环好，上3M

/************************************************************************
## 6.12日
************************************************************************/

硬件驱动有点诡异的问题  
用bangbang能降超调  

/************************************************************************
## 6.20日
************************************************************************/
增加可视距离控速  增加直道检测

/************************************************************************
## 6.24日
************************************************************************/
模糊维度变成斜率                      已写入  未尝试
优化过的大津法                         已写入  未尝试
施密特消图像点的抖动               未写入  未尝试
扫线宽度加大 让边界更加稳定    未写入  未尝试


速度80  不撞路肩P0-P6  2.05  2.11 2.15  2.17 2.18 2.22 2.22 
入弯D 2.60  出弯D3.14    前瞻25（摄像头未更改）
 速度85  不撞路肩P0-P6  2.05  2.11 2.14  2.17 2.17 2.21 2.22
  入弯D 2.64  出弯3.16    前瞻23（摄像头未更改）
  
  左转 -64  =  右转 70 


/************************************************************************
## 6.28日
************************************************************************/
试试10ms的舵机控制周期
圆环入环添加陀螺仪  
添加 各个元素的防误判距离  坡道  岔路口  越朴实越稳定   三大圆环的PD前瞻


弯道85-90  直道140  均速2.75左右  不撞路肩   加D可减轻出弯抖动  
驱动或者电机由于加减速过大被烧
Tow 26 
P  2.24
入弯D3.01  出弯D  3.67  

/************************************************************************
## 8.18日
************************************************************************/

国赛积分赛即将开始
三叉前瞻改短  左P可能还需要调整

/************************************************************************
## 8.23日
************************************************************************/
结束了 比亚迪丑牛2021    --375分   稳定国一
为期将近一年的准备，终于终于终于实现了自己最初的目标，国一，很想说什么，但是又说不出什么，回忆过往
的这些调车日志，莫名就会鼻子一酸，红了眼眶，这一切真的太不容易了。我依旧能清晰得记得这上面没一天写
下调车日志后的心情，时而欣喜，时而低落。有的问题一直解决不了，一周两周地被困在同一个问题下，真的令人
发疯，很幸运，他们都迎刃而解。再也不用通宵熬夜调车了，真的顶不住了。没人喜欢透支身体，没人喜欢无数夜晚
单刀面对丑牛的各种BUG，没人会喜欢这种看不到希望时候濒临崩溃的无助，我只是为我当时做出的选择负重前行
不知道这样一个选择到底最后是对还是错，但是做成功一件自己都觉得难以实现的事情，我已经知足了，无论最后
我将何去何从，我没有遗憾。
  瀚雷，斌杰，家一，都是丑牛的开发者之一，没有你们也没有2021年的丑牛，愿风流云散之后，在此后多年，仍会
  以此为傲。
   就这样吧，到此为止，比亚迪丑牛2021，圆满画上句号。
   
   
   
   
   
   

